<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>pluBee | Contas conectadas</title>
  <!-- Favicon -->
  <link rel="shortcut icon" href="/img/site/plubee-icon.png" type="image/x-icon">
  <!-- Custom styles -->
  <link rel="stylesheet" href="/css/admin/style.css">
</head>

<body>
  <div class="layer"></div>
  
  <!-- ! Body -->
  <div class="page-flex">

    <!-- ! Sidebar -->
    <%- include('../partials/sidebar-platform', {isAdmin: isAdmin}) %>

    <div class="main-wrapper">
      <!-- ! Main nav -->
      <%- include('../partials/nav-platform', {isAdmin: isAdmin, title: "Nova publicação"}) %>
  
      <!-- ! Main -->
      <main class="main users chart-page" id="skip-target">
        <div class="container">
          <div class="top-cat-title">
            <h2 style="color: #1877F2; display: flex; align-items: center;"><img src="/img/platform/facebook.png" width=45 height=45 alt="" style="margin-right: 12px;">Novo post Facebook</h2>
          </div>
          <div class="alert" style="display: none;"></div>
          <br>

          <div class="row">
            <div class="col-lg-12">
              <article class="white-block">
                <p style="font-size: 20px; margin-bottom: 10px; font-weight: bold; border-bottom: 2.5px solid #63636360; padding-bottom: 15px; color: #752A7A; display: flex; align-items: center;"><img src="/img/platform/perfil.png" width=28 height=28 alt="" style="margin-right: 12px;">Detalhes do post:</p>
                <div style="display: flex; flex-wrap: wrap;">
                  <select name="accounts-post" id="accounts-post">
                    <option value="select">Selecione a conta</option>
                    <% accounts.forEach(function(item) { %>
                      <option value="<%= item.id_account %>"><%= item.name %></option>
                    <% }) %>
                  </select>

                  <select name="pages-post" id="pages-post" style="margin-top: 1vw;">
                    <option value="select">Selecione a página</option>
                    <% pages.forEach(function(item) { %>
                      <option value="<%= item.id %>"><%= item.name_page %></option>
                    <% }) %>
                  </select>

                  <select name="groups-post" id="groups-post" style="margin-top: 1vw">
                    <option value="select">Selecione os grupos</option>
                    <% groups.forEach(function(item) { %>
                      <option value="<%= item.id %>"><%= item.name_group %></option>
                    <% }) %>
                  </select>
                </div>
                <br>
                <br>

                <p style="font-size: 20px; margin-bottom: 10px; font-weight: bold; border-bottom: 2.5px solid #63636360; padding-bottom: 15px; color: #752A7A; display: flex; align-items: center;"><img src="/img/platform/lapis.png" width=28 height=28 alt="" style="margin-right: 12px;">Descreva o post:</p>
                <p style="font-size: 15px; margin-bottom: 10px; font-weight: bold;">Escreva o post aqui:</p>
                <textarea name="" id="content-post" cols="30" rows="4" style="transition: none; padding: 10px;" placeholder="Hoje vamos aprender a preparar um café delicioso!"></textarea>
                <br>
                <p style="font-size: 15px; margin-bottom: 10px; font-weight: bold;">Inserir imagens:</p>
                <input type="file" name="files" id="files" style="border: 2px dashed #752A7A !important" class="files" multiple>
                <br>
                <p style="font-size: 15px; margin-bottom: 10px">Visualização:</p>
                <div class="results">
                </div>
                <br>
                <p style="font-size: 20px; margin-bottom: 10px; font-weight: bold; border-bottom: 2.5px solid #63636360; padding-bottom: 15px; color: #752A7A; display: flex; align-items: center;"><img src="/img/platform/tempo.png" width=28 height=28 alt="" style="margin-right: 12px;">Programar post</p>
                <div style="display: flex;">
                  <input type="radio" name="program" id="program-no" value="yes" tabindex="1"><p style="display: flex; justify-content: center; align-items: center; margin-right: 10px;">Programar</p>
                  <input type="radio" name="program" id="program-yes" value="no" tabindex="2"><p style="display: flex; justify-content: center; align-items: center;">Não programar</p>
                </div>
                <div class="program-div" style="margin-top: 30px; display: flex;">
                  <div style="margin-right: 16px;">
                    <p style="color: #752A7A; font-weight: bold; margin-bottom: 5px;">Escolha o dia:</p>
                    <input type="date" id="day">
                  </div>
                  <div>
                    <p style="color: #752A7A; font-weight: bold; margin-bottom: 5px;">Escolha a hora:</p>
                    <input type="time" id="hour">
                  </div>
                </div>
                <br>
                <br>
                <button style="color: #FFFFFF; background-color: #752A7A; padding: 13px; border-radius: 10px" onclick="post()">Inserir post</button>
              </article>
            </div>
          </div>
        </div>
      </main>

      <%- include('../partials/footer-platform') %>
    </div>
  </div>


<!-- Chart library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-file-upload/9.28.0/js/jquery.fileupload.min.js"></script>
<script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"></script>
<!-- Icons library -->
<script src="js/admin/feather.min.js"></script>
</body>
</html>

<script>
  let file_input = document.querySelector('#files');
  let image_preview = document.querySelector('.results');
  let images = [];

  const handle_file_preview = (e) => {
    let files = e.target.files;
    let length = files.length;

    for(let i = 0; i < length; i++) {
      let image = document.createElement('img');
      image.setAttribute('width', '80');
      image.setAttribute('height', '80');
      image.setAttribute('style', 'margin-right: 1rem; border-radius: 20px; border: 2px solid #752a7a');
      // use the DOMstring for source
      image.src = window.URL.createObjectURL(files[i]);
      image_preview.appendChild(image);

      // add image to images array
      images.push(files[i]);
      console.log(images)
    }
  }

  // listen for file input changes
  file_input.addEventListener('change', handle_file_preview);

  function post() {
    const account = document.querySelector('#accounts-post');
    const pages = document.querySelector('#pages-post');
    const groups = document.querySelector('#groups-post');
    const content = document.querySelector('#content-post');
    const day = document.querySelector('#day');
    const hour = document.querySelector('#hour');
    const program = document.querySelector('#program-no');
    const no_program = document.querySelector('#program-yes');

    const formData = new FormData();
    formData.append('account', account.value);
    formData.append('pages', pages.value);
    formData.append('groups', groups.value);
    formData.append('content', content.value);
    formData.append('program', program.checked);
    formData.append('day', day.value);
    formData.append('hour', hour.value);

    // append each file to the formData object
    for (let i = 0; i < images.length; i++) {
      formData.append('images[]', images[i], images[i].name);
    }

    fetch('/platform/post_facebook/new', {
      method: 'POST',
    })
    .then((response) => {
        if (response.ok) {
            const btn = document.getElementsByClassName(".btn-notify");
            const divMessage = document.querySelector(".alert");
            divMessage.style.display = "flex";
            divMessage.innerHTML = "";
            const message = document.createElement("p");
            const img = document.createElement("img");
            img.src = "/img/platform/checked.png"
            img.width = "28"
            img.height = "28"
            message.classList.add("message-notify");
            if (program.checked) {
              message.innerText = "Erro desconhecido";
            } else {
              message.innerText = "Erro desconhecido"
            }
            divMessage.appendChild(img);
            divMessage.appendChild(message);

            setTimeout(() => {
              divMessage.style.display = "none";
            }, 4000);
        } else {
          throw new Error("Erro ao processar a resposta da requisição");
        }
    })
    .catch((error) => {
        console.log(error)
    })
  }

  // const btn = document.getElementsByClassName(".btn-notify");
  // const divMessage = document.querySelector(".alert");

  // const msg = "teste de alerta";

  // function ativar(msg) {
  //   const message = document.createElement("div");
  //   message.classList.add("message");
  //   message.innerText = msg;
  //   divMessage.appendChild(message);

  //   setTimeout(() => {
  //     message.style.display = "none";
  //   }, 3000);
  // }
</script>